# MySQL技术内幕-InnoDB存储引擎第2版-学习笔记

# 第一章 MySQL体系结构和存储引擎

## 1.1 定义数据库和实例

+ 数据库database：

  物理操作系统文件或其他形式文件类型的集合。

  当使用NDB引擎时，数据库的文件可能不是操作系统上的文件，而是存放于内存中的文件，定义不变。

+ 实例instance：

  MySQL数据库由后台线程以及一个共享内存区组成。共享内存可以被运行的后台线程所共享。需要牢记的是，**数据库实例才是真正用于操作数据库文件的**。

​	一个实例对应一个数据库，一个数据库对应一个实例。**在集群情况下，可能存在一个数据库被多个数据实例使用的情况**。

​	**MySQL单进程多线程，MySQL数据库实例在系统上的表现就是一个进程**。

## 1.2 MySQL体系结构

> [MySQL体系结构_贾维斯的博客-CSDN博客_mysql体系结构](https://blog.csdn.net/u010735147/article/details/81330201)

![img](https://images2015.cnblogs.com/blog/540235/201609/540235-20160927083854563-2139392246.jpg)

+ 连接池组件
+ 管理服务和工具组件
+ SQL接口组件
+ 查询分析器组件
+ 优化器组件
+ 缓冲（Cache）组件
+ **插件式存储引擎**
+ 物理文件

MySQL数据库区别于其他数据库的最重要的一个特点就是插件式的表存储引擎。

**存储引擎基于表，而不是数据库**。

## 1.3 MySQL存储引擎

### 1.3.1 InnoDB存储引擎

​	MySQL5.5.8开始，InnoDB是默认的存储引擎。

+ InnoDB存储引擎**支持事务**
+ 主要面向在线事务处理（**OLTP**）应用
+ **行锁设计**
+ 支持外键
+ 支持类似Oracle的非锁定读，默认读操作不会产生锁
+ 数据存储在逻辑表内
+ MySQL4.1之后，InnoDB表单独存放到独立的ibd文件中
+ 支持用裸设备（raw disk）建立表空间
+ **多版本并发控制（MVCC）以支持高并发性**
+ **实现SQL标准的4种隔离级别，默认为REPEATABLE**
+ **使用next-key locking策略避免幻读（phantom）现象**
+ 提供**插入缓冲（insert buffer）**、**二次写（double write）**、**自适应哈希索引（adaptive hash index）**、**预读（read ahead）**等高性能和高可用的功能

+ 对于表中数据的存储，InnoDB存储引擎采用了聚集（clustered）的方式，因此**每张表的存储都是按主键的顺序进行存放**
+ **如果没有显式地在表定义时指定主键，InnoDB存储引擎会为每一行生成一个6字节的ROWID，并以此作为主键**

### 1.3.2 MyISAM存储引擎

在MySQL5.5.8之前MyISAM存储引擎是默认的存储引擎（除WIndows版本外）

+ **不支持事务**
+ **表锁设计**
+ 支持全文索引
+ 主要面向**OLAP**数据库应用
+ MyISAM的缓存池**只缓存(cache)索引文件，而不缓冲数据文件**

+ MyISAM存储引擎表由MYD和MYI组成，MYD用来存放数据文件，MYI用来存放索引文件

+ 可以使用myisampack工具进一步压缩数据文件

+ myisampack使用哈夫曼（Huffman）编码静态算法压缩数据，**压缩后的表是只读的**

+ MySQL5.0之前，MyISAM默认支持的表大小为4GB

  （如需支持更大的表，需指定MAX_ROWS和AVG_ROW_LENGTH属性）

+ MySQL5.0起，MyISAM默认支持256TB的单表数据

> 对于MyISAM存储引擎表，MySQL数据库只缓存索引文件，数据文件的缓存由操作系统本身完成，这与其他使用LRU算法缓存数据的大部分数据库不同。
>
> MySQL5.1.23之前，32位和64位的操作系统缓存索引的缓冲区最大只能设置为4GB，往后的版本64位系统可以支持大于4GB的索引缓冲区。

### 1.3.3 NDB存储引擎

​	NDB是集群存储引擎，类似Oracle的RAC集群。与Oracle RAC share everything架构不同，**NDB采用的是share nothing的集群架构，可用性更高**。

+ **数据全部存放在内存中**，主键查找（primaru key looups）速度极快

  （MySQL5.1开始，可以将非索引数据放在磁盘上）

+ 通过添加NDB数据存储节点（Data Node）可以线性提高数据库性能，是高可用、高性能的集群系统

+ **连接操作（JOIN）在MySQL数据库层完成，而不是在存储引擎层完成**

  （**复杂的连接操作需要巨大的网络开销，因此查询速度很慢**）

### 1.3.4 Memory存储引擎

​	之前称HEAP存储引擎。

+ **将表中的数据存放在内存中**

  （如果数据库重启或者发生崩溃，表中的数据都将消失）

+ 适合用于存储临时数据的临时表，以及数据仓库中的维度表

+ **默认使用哈希索引，而不是B+树索引**

+ **只支持表锁**，并发性能较差

+ **不支持TEXT和BLOB类型数据**

+ **存储变长字段（varchar）时，按照定长字段（char）方式存储，会造成内存浪费**

  （eBay的工程师Igor Chernyshev给出patch解决方案）

+ **MySQL数据库使用Memory存储引擎作为临时表来存放查询的中间结果集（intermediate result）。如果中间结果集大雨Memory存储引擎表的容量设置，又或者中间含有TEXT或BLOB列类型字段，则MySQL数据库会把其转换到MyISAM存储引擎表而存放到磁盘中。MyISAM不缓存数据文件，此时产生的临时表的性能对于查询会有损失**。

### 1.3.5 Archive存储引擎

+ **只支持INSERT和SELECT操作**
+ MySQL5.1起，支持索引
+ 使用zlib算法将数据行（row）进行压缩后存储，压缩比一般可达到1:10
+ **适合存储归档数据，如日志信息**
+ 使用**行锁**实现高并发插入操作
+ **非事务安全**，设计目标主要是提供高速插入和压缩功能

### 1.3.6 Federated存储引擎

+ **不存放数据，只是指向一台远程MySQL数据库服务器上的表**

  （类似SQL Server的链接服务器和Oracle的透明网关）

+ 只支持MySQL数据库表，不支持异构数据库表

### 1.3.7 Maria存储引擎

+ 设计目标是取代MyISAM，作为MySQL的默认存储引擎

  （可视为是MyISAM的后续版本）

+ **支持缓存数据和索引文件**

+ **行锁设计**

+ **提供MVCC功能**

+ **支持事务和非事务安全的选项**

+ 对BLOB字符类型的处理性能更好

### 1.3.8 其他存储引擎

Merge、CSV、Sphinx、Infobright等。

+ 支持全文索引：MyISAM、InnoDB（1.2版本）和Sphinx

+ 对于ETL操作，MyISAM更有优势；OLTP环境，InnoDB效率更高

+ 当表的数据量大于1000万时MySQL的性能会急剧下降吗？

  根据场景选择合适的存储引擎（以及正确的配置）。官方手册提及，Mytrix和Inc.在InnoDB上存储超过1TB的数据，还有一些网站使用InnoDB存储引擎，<u>处理插入/更新的操作平均800次/秒</u>

## 1.4 各储存引擎之间的比较

> [什么是存储引擎以及不同存储引擎特点 - wildfox - 博客园 (cnblogs.com)](https://www.cnblogs.com/wildfox/p/5815414.html)

![img](https://images2015.cnblogs.com/blog/798756/201608/798756-20160828170533471-1740775159.jpg)

+ 通过`SHOW ENGINES`或查找`information_schema`架构下的`ENGINES`表，可查看当前使用的MySQL数据库所支持的存储引擎

## 1.5 连接MySQL

连接MySQL操作是一个连接进程和MySQL数据库实例进行通信，本质上是**进程通信**。

进程通信的方式有管道、命名管道、TCP/IP套接字、UNIX域套接字等。

MySQL数据库提供的连接方式从本质上看即上述提及的进程通信方式。

### 1.5.1 TCP/IP

p26